FROM certpl/karton-system:v5.3.3

# Copy scripts for Railway deployment
COPY docker/generate-karton-config-system.py /usr/local/bin/generate-karton-config-system.py
COPY docker/wait-for-redis.sh /usr/local/bin/wait-for-redis.sh
RUN chmod +x /usr/local/bin/generate-karton-config-system.py /usr/local/bin/wait-for-redis.sh

# Create startup script that generates config and runs karton-system
# Note: S3 config is required by karton-system but we use --disable-gc to avoid using it
# The --disable-gc option disables garbage collection which requires S3
RUN echo '#!/bin/sh' > /usr/local/bin/start-karton-system.sh && \
    echo 'python3 /usr/local/bin/generate-karton-config-system.py' >> /usr/local/bin/start-karton-system.sh && \
    echo 'exec karton-system --disable-gc' >> /usr/local/bin/start-karton-system.sh && \
    chmod +x /usr/local/bin/start-karton-system.sh

# Override ENTRYPOINT to use our wait script, then execute our startup script
# The image has ENTRYPOINT ["karton-system"], so we override it
ENTRYPOINT ["/usr/local/bin/wait-for-redis.sh"]
CMD ["/usr/local/bin/start-karton-system.sh"]
