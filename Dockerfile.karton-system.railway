FROM certpl/karton-system:v5.3.3

# Copy scripts for Railway deployment
COPY docker/generate-karton-config-system.py /usr/local/bin/generate-karton-config-system.py
COPY docker/karton-system-wrapper.py /usr/local/bin/karton-system-wrapper.py
COPY docker/wait-for-redis.sh /usr/local/bin/wait-for-redis.sh
RUN chmod +x /usr/local/bin/generate-karton-config-system.py /usr/local/bin/karton-system-wrapper.py /usr/local/bin/wait-for-redis.sh

# Create startup script that generates config and runs karton-system with wrapper
# The wrapper patches karton-system to skip S3 bucket check
RUN echo '#!/bin/sh' > /usr/local/bin/start-karton-system.sh && \
    echo 'python3 /usr/local/bin/generate-karton-config-system.py' >> /usr/local/bin/start-karton-system.sh && \
    echo 'exec python3 /usr/local/bin/karton-system-wrapper.py --disable-gc' >> /usr/local/bin/start-karton-system.sh && \
    chmod +x /usr/local/bin/start-karton-system.sh

# Override ENTRYPOINT to use our wait script, then execute our startup script
# The image has ENTRYPOINT ["karton-system"], so we override it
ENTRYPOINT ["/usr/local/bin/wait-for-redis.sh"]
CMD ["/usr/local/bin/start-karton-system.sh"]
